# Alpha Pilot Bot OKX 业务逻辑分支流程图

## 📊 系统概述
Alpha Pilot Bot OKX 是一个基于AI驱动的自动化交易系统，采用模块化架构设计，实现智能交易决策、风险管理和系统维护。

---

## 🔄 主交易循环流程图

```mermaid
graph TD
    A[开始交易周期] --> B[获取市场数据]
    B --> C[分析市场状态]
    C --> D[获取AI信号]
    D --> E[处理交易信号]
    E --> F[检查风险管理]
    F --> G[检查横盘利润锁定]
    G --> H[系统维护]
    H --> I[等待下一个周期]
    I --> A
```

---

## 🎯 详细业务逻辑分支

### 1. 市场数据获取流程

```mermaid
graph TD
    A[获取市场数据] --> B{数据是否有效?}
    B -->|是| C[提取价格/成交量/持仓信息]
    B -->|否| D[记录错误并返回]
    C --> E[计算价格变化率]
    E --> F[获取历史K线数据]
    F --> G[返回完整市场数据]
```

### 2. 市场状态分析流程

```mermaid
graph TD
    A[分析市场状态] --> B[更新价格历史]
    B --> C[计算ATR波动率]
    C --> D[识别趋势强度]
    D --> E{波动率级别判断}
    E -->|>3%| F[高波动率]
    E -->|<1%| G[低波动率]
    E -->|其他| H[正常波动率]
    F --> I[返回市场状态]
    G --> I
    H --> I
```

### 3. AI信号获取与融合流程

```mermaid
graph TD
    A[获取AI信号] --> B{启用多AI模式?}
    B -->|是| C[获取多AI信号]
    B -->|否| D[获取单AI信号]
    C --> E[检查AI提供商可用性]
    E --> F[并行调用AI API]
    F --> G{API调用成功?}
    G -->|成功| H[收集成功信号]
    G -->|失败| I[记录失败并重试]
    I --> F
    H --> J[融合多AI信号]
    J --> K[计算共识度]
    K --> L[调整信心水平]
    L --> M[返回融合信号]
    D --> N[调用单AI API]
    N --> O{API调用成功?}
    O -->|成功| P[返回单AI信号]
    O -->|失败| Q[使用回退信号]
    Q --> M
    P --> M
```

### 4. AI信号融合详细逻辑

```mermaid
graph TD
    A[融合AI信号] --> B{信号数量?}
    B -->|0| C[使用回退信号]
    B -->|1| D[直接使用单信号]
    B -->|多个| E[多信号融合分析]
    
    E --> F[统计投票分布]
    F --> G[BUY/SELL/HOLD票数]
    G --> H[计算加权信心]
    H --> I[确定共识度]
    
    I --> J{共识度判断}
    J -->|≥80%| K[强共识决策]
    J -->|≥60%| L[多数支持决策]
    J -->|<60%| M[保守观望决策]
    
    K --> N[高信心信号]
    L --> O[中等信心信号]
    M --> P[降低信心观望]
    
    N --> Q[成功率检查]
    O --> Q
    P --> Q
    
    Q --> R{成功率<50%?}
    R -->|是| S[大幅降低信心]
    R -->|否| T[保持当前信心]
    
    S --> U[返回最终信号]
    T --> U
    C --> U
    D --> U
```

### 5. 交易信号处理流程

```mermaid
graph TD
    A[处理交易信号] --> B[获取当前持仓状态]
    B --> C[分析信号与持仓匹配度]
    C --> D{信号类型?}
    
    D -->|HOLD| E[HOLD信号处理]
    E --> F{是否有持仓?}
    F -->|是| G[保持现有持仓]
    F -->|否| H[继续空仓观望]
    
    D -->|BUY| I[BUY信号处理]
    I --> J{当前持仓状态?}
    J -->|无持仓| K[执行买入开仓]
    J -->|多头持仓| L[执行加仓]
    J -->|空头持仓| M[先平空仓再买入]
    
    D -->|SELL| N[SELL信号处理]
    N --> O{当前持仓状态?}
    O -->|无持仓| P{允许做空?}
    P -->|是| Q[执行卖出开仓]
    P -->|否| R[跳过交易]
    O -->|多头持仓| S[执行平仓]
    O -->|空头持仓| T[执行加仓]
    
    G --> U[信号执行完成]
    H --> U
    K --> U
    L --> U
    M --> U
    Q --> U
    R --> U
    S --> U
    T --> U
```

### 6. 风险管理流程

```mermaid
graph TD
    A[风险管理检查] --> B{是否有持仓?}
    B -->|否| C[跳过风险管理]
    B -->|是| D[获取持仓详细信息]
    
    D --> E[计算当前盈亏]
    E --> F[盈亏百分比分析]
    F --> G{盈亏状态?}
    
    G -->|盈利| H[盈利状态处理]
    H --> I[评估风险等级]
    I --> J[提供盈利建议]
    J --> K[设置保护性止盈]
    
    G -->|亏损| L[亏损状态处理]
    L --> M[评估亏损程度]
    M --> N{亏损程度?}
    N -->|≤-10%| O[高风险警告]
    N -->|≤-5%| P[中等风险警告]
    N -->|>-5%| Q[低风险监控]
    
    O --> R[建议立即止损]
    P --> S[密切关注市场]
    Q --> T[保持现有策略]
    
    G -->|平衡| U[平衡状态处理]
    U --> V[关注突破方向]
    V --> W[准备相应操作]
    
    K --> X[计算动态止盈止损]
    R --> X
    S --> X
    T --> X
    W --> X
    
    X --> Y[更新止盈止损设置]
    Y --> Z[风险管理完成]
    C --> Z
```

### 7. 横盘检测与处理流程

```mermaid
graph TD
    A[横盘利润锁定检查] --> B{是否有持仓?}
    B -->|否| C[跳过横盘检查]
    B -->|是| D[获取价格历史数据]
    
    D --> E[获取AI信号历史]
    E --> F[检测横盘状态]
    F --> G{是否横盘?}
    
    G -->|是| H[横盘处理]
    H --> I[分析横盘参数]
    I --> J[确定横盘动作]
    J --> K{动作类型?}
    
    K -->|partial_close| L[执行部分平仓]
    K -->|full_close| M[执行全部平仓]
    K -->|cancel_orders| N[取消所有挂单]
    
    L --> O[更新横盘状态]
    M --> O
    N --> O
    
    G -->|否| P[检查退出横盘]
    P --> Q{是否应该退出?}
    Q -->|是| R[重置横盘状态]
    Q -->|否| S[保持当前状态]
    
    R --> T[横盘检查完成]
    S --> T
    O --> T
    C --> T
```

### 8. 合约数量标准化流程

```mermaid
graph TD
    A[合约数量标准化] --> B{是否为平仓?}
    B -->|是| C[平仓专用标准化]
    B -->|否| D[普通交易标准化]
    
    C --> E[查询交易所合约规格]
    E --> F{获取成功?}
    F -->|是| G[使用OKX lot size]
    F -->|否| H[0.025特殊处理]
    
    H --> I[尝试0.01基本单位]
    I --> J{是否有效?}
    J -->|是| K[返回标准化数量]
    J -->|否| L[尝试常见lot size]
    
    L --> M[遍历0.001/0.01/0.1]
    M --> N{找到匹配?}
    N -->|是| K
    N -->|否| O[智能四舍五入]
    
    O --> P[根据数量级选择精度]
    P --> Q[确保≥最小交易量]
    Q --> K
    
    D --> R[标准标准化流程]
    R --> S[使用默认合约单位]
    S --> T[应用精度限制]
    T --> U[返回结果]
    
    K --> V[标准化完成]
    U --> V
    G --> V
```

### 9. AI信号获取重试机制

```mermaid
graph TD
    A[获取AI信号] --> B[初始化重试计数]
    B --> C[设置超时时间]
    C --> D[开始API调用]
    
    D --> E{API调用结果?}
    E -->|成功| F[解析响应数据]
    E -->|超时| G[记录超时错误]
    E -->|连接失败| H[记录连接错误]
    E -->|其他错误| I[记录其他错误]
    
    F --> J{数据有效?}
    J -->|是| K[返回有效信号]
    J -->|否| L[记录数据错误]
    
    G --> M[增加重试计数]
    H --> M
    I --> M
    L --> M
    
    M --> N{重试次数<最大重试?}
    N -->|是| O[等待重试间隔]
    O --> D
    N -->|否| P[标记为失败提供商]
    
    P --> Q[检查其他提供商]
    Q --> R{还有可用提供商?}
    R -->|是| S[尝试下一个提供商]
    R -->|否| T[使用回退信号]
    
    S --> D
    T --> U[返回回退信号]
    K --> V[信号获取完成]
    U --> V
```

### 10. 系统维护流程

```mermaid
graph TD
    A[系统维护] --> B[清理内存缓存]
    B --> C[清理价格历史缓存]
    C --> D{是否达到检查周期?}
    
    D -->|每5轮| E[更新系统统计]
    D -->|每10轮| F[内存统计和性能指标]
    D -->|每20轮| G[缓存统计]
    D -->|每100轮| H[清理旧数据]
    
    E --> I[记录系统状态]
    F --> J[保存性能指标]
    G --> K[记录缓存状态]
    H --> L[数据清理完成]
    
    I --> M[维护完成]
    J --> M
    K --> M
    L --> M
```

---

## 🎯 关键决策点说明

### 1. AI信号融合决策逻辑
- **强共识 (≥80%)**: 直接使用高信心信号
- **多数支持 (≥60%)**: 使用中等信心信号
- **无明显共识 (<60%)**: 保守观望，降低信心

### 2. 风险管理决策逻辑
- **盈利状态**: 设置保护性止盈，上调止损位
- **亏损状态**: 
  - ≤-10%: 高风险警告，建议立即止损
  - ≤-5%: 中等风险，密切关注
  - >-5%: 低风险监控
- **平衡状态**: 关注突破方向，保持现有设置

### 3. 合约数量标准化策略
- **优先策略**: 查询交易所实际合约规格
- **特殊处理**: 0.025数量使用0.01基本单位
- **备选策略**: 尝试常见lot size组合
- **最终回退**: 智能四舍五入到合理精度

### 4. 横盘检测触发条件
- 价格波动率低于阈值
- 持续时间超过设定值
- AI信号持续为HOLD
- 持仓处于盈利状态

---

## 🔧 配置参数影响

### 关键配置参数
1. **AI融合阈值**: 影响信号决策的严格程度
2. **风险管理参数**: 影响止盈止损设置
3. **横盘检测参数**: 影响横盘识别灵敏度
4. **合约标准化参数**: 影响订单数量精度

### 调优建议
- **保守型**: 提高共识度阈值，降低风险容忍度
- **激进型**: 降低共识度要求，提高风险容忍度
- **平衡型**: 使用默认参数，适合大多数情况

---

## 📋 修改指南

### 常见修改场景

1. **调整AI融合逻辑**: 修改 `ai_client.py` 中的 `fuse_signals()` 方法
2. **优化风险管理**: 修改 `main.py` 中的 `_update_risk_management()` 方法
3. **改进横盘检测**: 修改 `strategies.py` 中的横盘检测逻辑
4. **调整合约标准化**: 修改 `trading.py` 中的 `_standardize_contract_amount()` 方法

### 测试验证
- 使用 `syntax_check.py` 验证语法正确性
- 使用模拟模式测试新逻辑
- 查看详细日志确认行为符合预期

---

*最后更新: 2025年12月6日*
*版本: v2.1 - 增强决策透明度版*